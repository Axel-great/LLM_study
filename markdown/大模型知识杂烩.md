## å¤§æ¨¡å‹çŸ¥è¯†æ‚çƒ©

### 1.KV cache

 	kvcacheç”¨äºåŠ é€Ÿè®¡ç®—attentionï¼Œå¯¹äºä¹‹å‰å·²ç»è®¡ç®—è¿‡çš„QKå€¼è¿›è¡Œå±è”½ï¼Œ**åªå¯¹æ–°é¢„æµ‹å‡ºæ¥çš„å€¼è¿›è¡ŒKVè®¡ç®—**ï¼Œå‡å°‘çŸ©é˜µçš„è¿ç®—é‡ã€‚ï¼ˆå›¾æºbç«™@llmå¼ è€å¸ˆï¼‰

â€‹	![image-20250219155247833](assets/image-20250219155247833.png)



â€‹	å¯¹ä¹‹å‰çš„KVçŸ©é˜µè¿›è¡Œç¼“å­˜ï¼Œè¿™æ ·å°±æ— éœ€é‡æ–°è®¡ç®—ä¹‹å‰å·²ç»è®¡ç®—è¿‡çš„çŸ©é˜µï¼Œç›´æ¥æŠŠæ–°çŸ©é˜µåŠ å…¥å³å¯

![v2-7bb8303b0a82b7ae668e2e9327b274e2_r](assets/v2-7bb8303b0a82b7ae668e2e9327b274e2_r.jpg)
$$
\$$
\begin{aligned}
    \textcolor{orange}{Att_1}(Q, K, V) &= \text{softmaxed}(\textcolor{orange}{Q_1} K_1^T) \vec{V}_1 \\
    \textcolor{red}{Att_2}(Q, K, V) &= \text{softmaxed}(\textcolor{red}{Q_2} K_1^T) \vec{V}_1 + \text{softmaxed}(\textcolor{red}{Q_2} K_2^T) \vec{V}_2 \\
    \textcolor{purple}{Att_3}(Q, K, V) &= \text{softmaxed}(\textcolor{purple}{Q_3} K_1^T) \vec{V}_1 + \text{softmaxed}(\textcolor{purple}{Q_3} K_2^T) \vec{V}_2 + \text{softmaxed}(\textcolor{purple}{Q_3} K_3^T) \vec{V}_3 \\
    \textcolor{red}{Att_4}(Q, K, V) &= \text{softmaxed}(\textcolor{red}{Q_4} K_1^T) \vec{V}_1 + \text{softmaxed}(\textcolor{red}{Q_4} K_2^T) \vec{V}_2 + \text{softmaxed}(\textcolor{red}{Q_4} K_3^T) \vec{V}_3 \\
    &\quad + \text{softmaxed}(\textcolor{red}{Q_4} K_4^T) \vec{V}_4
\end{aligned}
\$$
$$
â€‹	å‰é¢è¾“å…¥å¯¹è¯æ¡†çš„å†…å®¹ä¹Ÿä¼šåœ¨æ–°å¯¹è¯æ—¶ï¼Œé‡æ–°è¾“å…¥è¿›Transformeré‡Œé¢ï¼Œè¿™æ ·æ‰æœ‰äº†ä¸Šä¸‹æ–‡å…³è”ã€‚æ‰€ä»¥è¿™ä¼šå¯¼è‡´è¾“å…¥çš„æ•°æ®è¶Šæ¥è¶Šå¤§ï¼Œä»¥å‰çš„å¤„ç†æ–¹å¼ä¸ºï¼šä»¥æœ€æ–°å†…å®¹ä¸ºé•¿åº¦4096ï¼Œæˆªæ–­ä»¥å‰çš„å¯¹è¯å†…å®¹ã€‚æœ‰äº†KV Cacheä¹‹åå¯ä»¥å¤§é‡å‡å°‘å†…å­˜æ¶ˆè€—ï¼Œæ‰©å¤§ä¸Šä¸‹æ–‡å…³è”åº¦

![image-20250219155422079](assets/image-20250219155422079.png)

### 2. MHAã€MQAã€GQA

â€‹	MHAä¸ºä¸€ä¸ªQueryå¯¹åº”ä¸€ä¸ªKã€V

â€‹	MQAä¸ºä¸€ç¾¤Queryå¯¹åº”ä¸€ä¸ªKã€V

â€‹	GQAä¸ºå‡ ä¸ªQueryå¯¹åº”ä¸€ä¸ªKã€V

â€‹	GQAç›¸å½“äºå­˜å‚¨å™¨é‡Œé¢çš„ç»„ç›¸è¿



![image-20250219171706217](assets/image-20250219171706217.png)

â€‹	ä¸åŒQKVåŒ¹é…ä¸‹çš„ä¸åŒè®¡ç®—å‚æ•°ï¼Œå•ä¸€é“¾æ¥é€Ÿåº¦æœ€å¿«ï¼Œä½†æ˜¯ç²¾åº¦æœ€ä½ï¼Œè€Œç»„ç›¸è¿ç²¾åº¦ä¸å…¨ç›¸è”å·®ä¸å¤šï¼Œä½†æ˜¯æ—¶é—´å°‘äº†å°†è¿‘å››å€

![image-20250219171726267](assets/image-20250219171726267.png)

### 2.Sparse Attention å’Œ Infine Attention

#### 2.1 Sparse  Attention

â€‹	ç¨€ç–æ³¨æ„åŠ›å¯¹==**QK**==çŸ©é˜µè¿›è¡Œäº†ä¼˜åŒ–ã€‚

- é¦–å…ˆå¯¹çŸ©é˜µè¿›è¡Œéšæœºå…³æ³¨
- ç„¶åè¿›è¡Œå¯¹è§’çº¿å…³æ³¨ã€‚è¿™æ ·çªå‡ºçš„æ˜¯ç›¸é‚»ä¸¤ä¸ªè¯çš„å…³æ³¨åº¦ï¼Œå› ä¸ºåœ¨ç›¸é‚»çš„ä¸¤ä¸ªè¯ä¹‹é—´ç›¸å…³æ€§æœ€é«˜
- å…¶æ¬¡å¯¹å¥å­çš„ç¬¬ä¸€ã€ç¬¬äºŒä¸ªè¯è¿›è¡Œå…¨æ–‡çš„å…³æ³¨
- æœ€åå°†å…¶æ‹¼æ¥ï¼Œæ„æˆç¨€ç–å…³æ³¨åº¦çŸ©é˜µ

![image-20250219173810949](../../../typora_image/image-20250219173810949.png)

#### 2.2 Infine Attention

- åœ¨Segmengt1è¾“å…¥ä¸€æ®µtokensï¼Œç„¶åå¯¹å…¶**è¾“å‡ºçš„KVçŸ©é˜µè¿›è¡Œç¼“å­˜**ã€‚
- ç„¶ååœ¨Segment2ä¸­å†è¾“å…¥ä¸€æ®µtokensï¼Œè®¡ç®—å‡ºè‡ªå·±çš„KVä¸Qçš„å€¼ï¼Œå¹¶ç¼“å­˜KVçŸ©é˜µã€‚
- ä¸ä¸Šä¸€å±‚çš„KVçŸ©é˜µè¿›è¡ŒConcatï¼Œå†ç»è¿‡ä¸€ä¸ªlinearå±‚ï¼ˆä¼°è®¡æœ€åè¿˜ä¼šå˜å›KVç›¸åŒç»´åº¦çš„çŸ©é˜µå¤§å°ç”¨äºä¸‹ä¸€æ¬¡ä½¿ç”¨ï¼‰

![image-20250219180725192](assets/image-20250219180725192.png)

â€‹	KVå‹ç¼©çŸ©é˜µå°±æ˜¯æŠŠåŸæ¥QKç›¸ä¹˜çš„æ­¥éª¤æ”¹ä¸ºå…ˆKVã€‚QKçŸ©é˜µé”è¡¨ç¤ºçš„æ˜¯ä¸Šä¸‹æ–‡è¯ä¹‹é—´çš„è¯­éŸ³å…³ç³»ï¼Œè€ŒKVè¡¨ç¤ºçš„æ˜¯è¯­éŸ³ç‰¹å¾å‘é‡çš„ä¹‹é—´å…³ç³»çš„çŸ©é˜µï¼Œä»–çš„çŸ©é˜µç»´åº¦ç›¸æ¯”QKè¦å°çš„å¾ˆå¤šã€‚

![image-20250219181533659](assets/image-20250219181533659.png)

![image-20250219182202474](assets/image-20250219182202474.png)

### 3.å½’ä¸€åŒ–

Batch_Normä¸ºå¯¹ä¸€æ‰¹çš„æ•°æ®è¿›è¡Œå½’ä¸€åŒ–

Layer_Normä¸ºå¯¹æ‰€æœ‰batchçš„ç‰¹å¾è¿›è¡Œå½’ä¸€åŒ–

![img](assets/ae2fb9927c4ce9457a5737fd6380c958.jpeg)

### 4.å¤§æ¨¡å‹Promptæ ¼å¼

#### ğŸ“Œ `apply_chat_template()` ä½œç”¨  

å®ƒçš„ä½œç”¨æ˜¯**å°†èŠå¤©è®°å½•è½¬æ¢ä¸ºæ¨¡å‹æ‰€éœ€çš„ prompt æ ¼å¼**ï¼Œä¸åŒçš„æ¨¡å‹æ ¼å¼ä¸åŒï¼Œæ¯”å¦‚ï¼š  

#### ğŸ”¹ LLaMA2 æ ¼å¼  

```markdown
<|system|>
You are a helpful assistant.

<|user|>
What is the capital of France?

<|assistant|>
The capital of France is Paris.

<|user|>
How about Germany?
```

#### ğŸ”¹ OpenChat / ChatML æ ¼å¼  

~~~markd
<|im_start|>system
You are a helpful assistant.<|im_end|>

<|im_start|>user
What is the capital of France?<|im_end|>

<|im_start|>assistant
The capital of France is Paris.<|im_end|>

<|im_start|>user
How about Germany?<|im_end|>
~~~



